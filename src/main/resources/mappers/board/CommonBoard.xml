<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.example.finalpro.dao.BoardDAO">

    <!--  책 카테고리 -->
    <select id="bookCategory" resultType="com.example.finalpro.vo.QboardVO">
        SELECT B.BOOK_CA_NO AS BOOK_CA_NO, B.BOOK_CA_NAME AS BOOK_CA_NAME, SU.SUB_CA_NAME AS SUB_CA_NAME
        FROM BOOK_CA B,(SELECT * FROM SUB_CA WHERE SUB_CA_NO = #{param1}) SU
        WHERE B.SUB_CA_NO = SU.SUB_CA_NO
    </select>

    <!--  서브 카테고리 반환  -->
    <select id="subCategory" resultType="String">
        SELECT SUB_CA_NAME
        FROM SUB_CA
        WHERE SUB_CA_NO = #{param1}
    </select>

    <!--Q게시판 글쓰기-->
    <insert id="qBoardInsert" parameterType="com.example.finalpro.vo.QboardVO">
        INSERT INTO Q(q_no, mem_no, sub_ca_no, book_ca_no,  q_title, q_content, q_sos, q_up, q_rpt_cnt, q_admin_state)
         VALUES (Q_SEQ.NEXTVAL, #{mem_no}, #{sub_ca_no}, #{book_ca_no}, #{q_title}, #{q_content}, 0, 0, 0, 0)
    </insert>

    <!--게시글 조회-->
    <select id="qBoardList" resultType="com.example.finalpro.vo.QboardVO">
        select q_no,mem_no,ca.sub_ca_name,ca.sub_ca_no,book_ca_name,bca.book_ca_no,q_title,
        q_content,q_sos,q_up,q_rpt_cnt,q_date,q_admin_state
        from q q1, (select * from sub_ca) ca,(select * from book_ca) bca
        where q1.sub_ca_no = ca.sub_ca_no
        and bca.book_ca_no = q1.book_ca_no
        and q1.sub_ca_no = #{param1}
    </select>

    <!-- 해당 게시글 조회-->
    <select id="qBoardContent" resultType="com.example.finalpro.vo.QboardVO">
        select q1.q_no,q1.mem_no, ca.sub_ca_name,ca.sub_ca_no,book_ca_name,bca.book_ca_no,q_title,
        q_content,q_sos,q_up,q_rpt_cnt,q_date,q_admin_state,m.mem_nick
        from q q1, (select * from sub_ca) ca,(select * from book_ca) bca,(select * from mem)m
        where q1.sub_ca_no = ca.sub_ca_no
        and bca.book_ca_no = q1.book_ca_no
        and q1.mem_no = m.mem_no
        and q1.sub_ca_no =#{param2}
        and q1.q_no=#{param1}
    </select>
    
    <!-- 추천 체크 -->
    <select id="qBoardUpCheck" resultType="Integer">
		SELECT nvl(max(mem_no), 0)
			FROM 
				(SELECT MEM_NO 
				FROM UP 
				WHERE Q_NO=#{q_no} 
				AND MEM_NO=#{mem_no})
    </select>
    
    <!-- 추천 액션-->
    <update id="qBoardUpUpdate" parameterType="com.example.finalpro.vo.QboardVO">
        UPDATE Q SET Q_UP=Q_UP+1 WHERE Q_NO=#{q_no}
    </update>
    <insert id="qBoardUpInsert" parameterType="com.example.finalpro.vo.QboardVO">
        INSERT INTO UP VALUES(UP_SEQ.nextval,#{q_no},#{mem_no})
    </insert>


    <!-- 게시판 신고 체크-->
    <select id="qBoardDownCheck" resultType="Integer">
        SELECT NVL(MAX(RD.MEM_NO), 0)
        FROM Q,
        (SELECT R.RPT_NO, R.RPT_CONTENT, D.DOWN_NO, D.Q_NO, D.MEM_NO
        FROM RPT R, DOWN D
        WHERE R.RPT_NO = D.RPT_NO) RD
        WHERE Q.Q_NO = RD.Q_NO
        AND Q.Q_NO = #{param2}
        AND RD.MEM_NO = #{param1}
    </select>

    <!-- 게시판 신고 업데이트 -->
    <update id="qBoardDownUpdate">
        UPDATE Q
        SET Q_RPT_CNT = +1
        WHERE Q_NO = #{param1}
    </update>

    <!-- 게시판 신고 입력-->
    <insert id="qBoardDownInsert">
        INSERT INTO DOWN VALUES(DOWN_SEQ.NEXTVAL, #{param1}, #{param3}, #{param2})
    </insert>


    <!-- 댓글쓰기-->
    <insert id="replyInsertProcess" parameterType="com.example.finalpro.vo.ReplyBoardVO">
        INSERT INTO REPLY VALUES(REPLY_SEQ.NEXTVAL, #{mem_no}, #{q_no}, #{reply_content}, 0, 0, 0, SYSDATE)
    </insert>

    <!-- 댓글 리스트 -->
    <select id="replyList" parameterType="com.example.finalpro.vo.ReplyBoardVO" resultType="com.example.finalpro.vo.ReplyBoardVO">
        SELECT M.MEM_NO MEM_NO, M.MEM_NICK MEM_NICK, RP.Q_NO Q_NO, RP.REPLY_CONTENT REPLY_CONTENT
        , RP.REPLY_UP REPLY_UP, RP.REPLY_PICK, REPLY_PICK, RP.REPLY_RPT_CNT REPLY_RPT_CNT, RP.REPLY_NO REPLY_NO
        FROM MEM M, REPLY RP
        WHERE M.MEM_NO = RP.MEM_NO
        AND RP.Q_NO = #{q_no}
    </select>

    <!-- 댓글 추천 체크 -->
    <select id="replyUpCheck" resultType="Integer">
        SELECT nvl(max(mem_no), 0)
        FROM
        (SELECT MEM_NO
        FROM REPLY_UP
        WHERE REPLY_NO=#{param2}
        AND MEM_NO=#{param1})
    </select>

    <!-- 댓글 추천 업데이트-->
    <update id="replyUpUpdate">
        UPDATE REPLY
        SET REPLY_UP = REPLY_UP+1
        WHERE REPLY_NO=#{param1}
    </update>

    <!-- 댓글 추천 INSERT-->
    <insert id="replyUpInsert">
        INSERT INTO REPLY_UP VALUES(REPLY_UP_SEQ.NEXTVAL, #{param1}, #{param2})
    </insert>
    <!-- 댓글 채택-->
    <update id="replyPick">
        UPDATE REPLY
        SET REPLY_PICK = REPLY_PICK+1
        WHERE REPLY_NO = #{param1}
    </update>

    <!-- 댓글 채택 후 나머지 -1 초기화 -->
    <update id="replyAnotherPick">
        <![CDATA[
        UPDATE REPLY
        SET REPLY_PICK = -1
        WHERE REPLY_PICK < 1
        ]]>
    </update>

    <!-- 댓글 신고 체크 -->
    <select id="replyDownCheck" resultType="Integer">
        SELECT NVL(MAX(RD.MEM_NO), 0)
        FROM REPLY R,
        (SELECT R.RPT_NO, R.RPT_CONTENT, D.REPLY_DOWN_NO, D.REPLY_NO, D.MEM_NO
        FROM RPT R, REPLY_DOWN D
        WHERE R.RPT_NO = D.RPT_NO) RD
        WHERE R.REPLY_NO = RD.REPLY_NO
        AND R.REPLY_NO = #{param1}
        AND RD.MEM_NO = #{param2}
    </select>

    <!-- 댓글 신고 업데이트 -->
    <update id="replyDownUpdate">
        UPDATE REPLY
        SET REPLY_RPT_CNT = REPLY_RPT_CNT + 1
        WHERE REPLY_NO = #{param1}
    </update>

    <!-- 댓글 신고 INSERT -->
    <insert id="replyDownInsert">
        INSERT INTO REPLY_DOWN VALUES(REPLY_DOWN_SEQ.NEXTVAL, #{param1}, #{param3}, #{param2})
    </insert>


</mapper>